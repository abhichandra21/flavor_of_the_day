#!/usr/bin/env bash

set -e

cd "$(dirname "$0")/.."

echo "üåê Testing Provider Connectivity"
echo "================================"

# Try to use virtual environment if available
if [ -d "venv" ] && [ -f "venv/bin/activate" ]; then
    echo "üì¶ Using virtual environment..."
    source venv/bin/activate
    # Check if python is available in venv
    if command -v python >/dev/null 2>&1; then
        PYTHON_CMD="python"
    elif command -v python3 >/dev/null 2>&1; then
        PYTHON_CMD="python3"
    else
        echo "‚ö†Ô∏è  No Python found in venv, using system python3"
        PYTHON_CMD="python3"
    fi
else
    PYTHON_CMD="python3"
fi

# Test provider connectivity without full HA setup
$PYTHON_CMD -c "
import asyncio
import aiohttp
import sys
sys.path.insert(0, 'custom_components')

from flavor_of_the_day.providers.culvers import CulversProvider

async def test_providers():
    async with aiohttp.ClientSession() as session:
        print('üè™ Testing Culver\'s Provider...')
        provider = CulversProvider(session, {})

        try:
            # Test connection
            can_connect = await provider.test_connection()
            print(f'  Connection: {'‚úÖ OK' if can_connect else '‚ùå Failed'}')

            # Test location search
            locations = await provider.search_locations('Madison', 'WI')
            print(f'  Location search: ‚úÖ Found {len(locations)} locations')

            if locations:
                # Test getting specific location
                location = await provider.get_location_by_id(locations[0]['store_id'])
                print(f'  Location details: ‚úÖ Got details for {location['name']}')

                # Test getting flavor (might fail, that's OK)
                try:
                    flavor = await provider.get_current_flavor(locations[0]['store_id'])
                    print(f'  Current flavor: ‚úÖ {flavor['name']}')
                except Exception as e:
                    print(f'  Current flavor: ‚ö†Ô∏è  Could not fetch ({str(e)[:50]}...)')

        except Exception as e:
            print(f'  ‚ùå Provider test failed: {e}')

if __name__ == '__main__':
    asyncio.run(test_providers())
"

echo ""
echo "Provider connectivity test complete!"